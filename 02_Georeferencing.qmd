---
title: "Пространственная привязка и создание объектов"
subtitle: "Основы геоинформатики. Лекция 2"
date: 02/16/2024
date-format: long
author: "Самсонов Тимофей Евгеньевич"
execute:
  echo: false
  freeze: true
engine: knitr
format:
  revealjs: 
    theme: [default, custom.scss]
    margin: 0.2
    slide-number: true
    footer: "Самсонов Т. Е. Основы геоинформатики: курс лекций для студентов географического факультета МГУ"
    header-includes: <link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/pt-sans" type="text/css"/>
bibliography: references.yaml
mainfont: PT Sans
---

## Пространственная привязка

**Пространственная привязка [@gost:70316-2022]**

:   Описание позиции в реальном мире.

Пространственная привязка может быть осуществлена двумя основными способами:

-   с использованием координат;
-   посредством географических идентификаторов.

::: callout-important
## Координатная система отсчета

При использовании привязки по координатам необходимо описание координатно системы отсчета.
:::

## Координатная система отсчета (КСО)

При описании координатной системы отсчета последовательно указываются:

1.  **Эллипсоид вращения** --- тело, по отношению к которому вычисляются геодезические координаты точек (широта, долгота)
2.  **Исходные геодезические даты (датум)** --- параметры положения эллипсоида в теле Земли
3.  **Географическая система координат** --- включает датум, положение начального меридиана и единицы измерения широт и долгот
4.  **Проекция** --- математический способ перехода от геодезических (географических) координат к плоским прямоугольным.
5.  **Плоская прямоугольная система координат** --- включает проекцию, ее параметры и единицы измерения координат.

## Операции с КСО

При работа с пространственными данными используется 4 основных операции на КСО:

1.  **Создание** --- позволяет сопроводить данные информацией о том, в какой системе хранятся координаты объектов.

2.  **Переопределение** --- используется в случае, если КСО указана неправильно. Например, данные хранятся в градусах, а в параметрах указано, что это проекция Меркатора.

3.  **Чтение** --- используется программным обеспечением для того чтобы правильно позиционировать объекты относительно референцного тела (Земли).

4.  **Преобразование** --- используется для получения нового набора данных в другой системе координат.

## Преобразование координат

::: columns
::: {.column width="55%"}
Преобразование координат включает три различных операции:

1.  **Трансформирование** --- пересчет географических координат с одного датума на другой.

2.  **Проецирование** --- от географических координат к плоским прямоугольным.

3.  **Обратное проецирование** --- от плоских прямоугольных координат к географическим.
:::

::: {.column width="45%"}
![](images/coord_transform.png){width="60%"}
:::
:::

## Форматы описания

Распространены 3 формата описания координатных систем отсчета:

-   **PROJ.4 String** --- представление в виде строки параметров.

-   **WKT (Well-Known Text)** --- представление в виде иерархического списка. Это *наиболее полный* формат описания системы координат, который рекомендуется к использованию для избежания неоднозначностей.

-   **EPSG (European Petroleum Survey Group)** --- представление в виде числового кода.

::: callout-tip
## Где найти описания?

Для поиска КСО в перечисленных форматах представления удобно воспользоваться порталом **spatialreference.org**.
:::

## PROJ.4 String

```{css}
.code-block {
 max-height: 600px;
 scrollable: false
}
```

**PROJ.4 String** --- строковый формат представления информации о КСО, введенный в библиотеке [**PROJ**](http://proj.org), начиная с версии 4. Основные параметры:

``` code-block
+datum     Датум
+ellps     Эллипсоид
+lat_0     Широта стандартной параллели
+lat_1     Широта первой стандартной параллели
+lat_2     Широта второй стандартной параллели
+lat_ts    Широта нулевых искажений
+lon_0     Центральный меридиан
+proj      Проекция
+units     Единицы измерения координат
+vunits    Единицы измерения высот
+x_0       Восточное указание
+y_0       Северное указание
+zone      Номер зоны
```

## PROJ.4 String --- примеры

-   Географические координаты в СК **WGS84** (без проекции):

```{r}
library(sf)
cat(st_crs(4326)$proj4string)
```

-   Проекция **Web Mercator** (Google Maps, Яндекс.Карты и т.д.):

```{r}
cat(st_crs(3857)$proj4string)
```

-   **Коническая равнопромежуточная** проекция:

```{r}
cat(st_crs('ESRI:54027')$proj4string)
```

-   Проекция **UTM, зона 37**:

```{r}
cat(st_crs(32637)$proj4string)
```

## WKT (Well-Known Text)

**WKT** основан на следующих принципах.

-   Каждый объект представляется в виде токена, состоящего из ключевого слова, за которым следует множество атрибутов объекта.

-   Некоторые объекты состоят из других объектов, поэтому результат может состоять из нескольких уровней вложенности.

``` code
KEYWORD1[
  attribute1, 
  KEYWORD2[
    attribute2, 
    attribute3,
    KEYWORD3[
      attribute4
    ]
  ]
]
```

## WKT (Well-Known Text)

Наиболее часто встречающиеся токены

| Токен         | Назначение                                                         |
|-----------------|-------------------------------------------------------|
| `GEOGCRS`     | Географическая координатная система отсчета                        |
| `PROJCRS`     | Проецированная координатная система отсчета                        |
| `BASEGEOGCRS` | Географическая КСО, на которой основана проецированная             |
| `DATUM`       | Датум                                                              |
| `ELLIPSOID`   | Эллипсоид                                                          |
| `PRIMEM`      | Начальный меридиан                                                 |
| `CS`          | Система координат (декартова, сферическая, эллипсоидальная и т.д.) |

## WKT (Well-Known Text)

| Токен         | Назначение                                |
|---------------|-------------------------------------------|
| `ANGLEUNIT`   | Единица измерения углов                   |
| `LENGTHUNIT`  | Единица измерения длин                    |
| `CONVERSION`  | Преобразование (проекция + параметры)     |
| `METHOD`      | Проекция                                  |
| `PARAMETER`   | Параметр                                  |
| `USAGE`       | Область применения                        |
| `REMARK`      | Ремарка (здесь могут быть любые символы!) |
| `ID`          | Идентификатор                             |
| `AXIS`        | Ось                                       |
| `ORDER`       | Порядок оси                               |

## WKT (Well-Known Text)

**Пример: географическая КСО**

``` code
GEOGCRS["NTF (Paris)",
  DATUM["Nouvelle Triangulation Francaise", 
    ELLIPSOID["Clarke 1880 (IGN)",6378249.2,293.4660213]
  ], 
  PRIMEM["Paris",2.5969213],
  CS[ellipsoidal,2],
    AXIS["latitude",north,ORDER[1]],
    AXIS["longitude",east,ORDER[2]],
    ANGLEUNIT["grad",0.015707963267949],
  REMARK["Nouvelle Triangulation Française"]
]
```

::: callout-important
## Обратите внимание

Данная система отсчета использует нестандартный меридиан (*Парижский*) и угловые единицы (*грады*).
:::

## WKT (Well-Known Text)

**Пример: проецированная КСО (проекция Мольвейде)**

``` {.code-block style="font-size: 0.75em;"}
PROJCRS["World_Mollweide",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["Degree",0.0174532925199433]]],
    CONVERSION["World_Mollweide",
        METHOD["Mollweide"],
        PARAMETER["Longitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["False easting",0, LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0, LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,  ORDER[1], LENGTHUNIT["metre",1]],
        AXIS["(N)",north, ORDER[2], LENGTHUNIT["metre",1]],
    USAGE[SCOPE["Not known."],AREA["World."], BBOX[-90,-180,90,180]],
    ID["ESRI",54009]]
```

## EPSG

**EPSG (European Petroleum Survey Group)** --- европейская рабочая группа нефтегазовой области, которая ведет реестр КСО с уникальными цифровыми кодами вида `EPSG:xxxxxx`.

Коды EPSG оказались удобны, поэтому используются повсеместно для быстрой инициализации проекций со стандартными параметрами.

Например, ранее рассмотренные проекции имеют коды:

-   *WGS84*: `EPSG:4326`
-   *Web Mercator*: `EPSG:3857`
-   *UTM*: `EPSG:326..` , например для UTM 37N: `EPSG:32637`

## Описание КСО в QGIS

![](images/mollweide_1.png){width="100%"}

## Описание КСО в QGIS

![](images/mollweide_2.png){width="100%"}

## spatialreference.org

Удобный ресурс для поиска описаний координатных систем отсчета

![](images/image-1882413297.png)

## proj.org

Сайт библиотеки PROJ имеет описания проекций

![](images/image-69855955.png)

`Coordinate operations —> Projections`

## projectionwizard.org

Веб-приложение для выбора оптимальной проекции

![](images/image-634598051.png)

## Координатная привязка

Координатная привязка

:   Преобразование координат, которое привязывает пространст-венные объекты к их местоположению в реальном мире.

::: callout-tip
## Когда нужна координатная привязка?

1.  Информация о СК отсутствует или ошибочна *(например --- сканированная карта)*.
2.  Информация о СК имеется, но координаты объектов искажены и требуют корректировки *(например, есть систематическая ошибка в измерениях)*.
:::

::: callout-note
## Регистрация

Процесс координатной привязки также называют **регистрацией**.
:::

## Опорные точки

Координатная привязка выполняется по **опорным точкам**.

::: columns
::: {.column width="60%"}
![](images/control_pts.svg){width="100%"}
:::

::: {.column width="40%"}
Необходимо указать несколько пар точек.

Каждая пара создается в следующем порядке:

-   сначала в текущем положении (**p**)

-   затем в истинном положении (**q**).
:::
:::

Полученные вектора используются для трансформации координат.

## Аффинное преобразование

Аффинное преобразование

:   Отображение плоскости или пространства в себя, при котором параллельные прямые переходят в параллельные прямые, пересекающиеся --- в пересекающиеся, скрещивающиеся --- в скрещивающиеся

Позволяет решать простые случаи привязки:

![](images/affine.svg){width="100%"}

## Неаффинные преобразования

В тех случаях, когда аффинных преобразований недостаточно, могут быть использованы более сложные:

![](images/nonaffine.svg){width="100%"}

Метод резинового листа является наиболее гибким и позволяет делать локализованные трансформации объектов (изображений).

## Опорные точки

Принципы выбора опорных точек:

1.  **Количество точек должно быть *больше* минимально необходимого**. Это позволит оценить погрешность трансформации. Например для аффинного преобразования вместо 3 желательно набрать как минимум 4 точки.
2.  **Точки должны располагаться относительно равномерно** по полю привязываемого объекта. Необходимы точки как по краям, так и в центре.
3.  **Точки не должны *все* располагаться на одной прямой**. Чем сильнее точки тяготеют к такой конфигурации, тем хуже будет качество привязки.

## Создание объектов

Создание векторных пространственных объектов осуществляется разными способами. Наиболее распространены:

1.  **Автоматическое конструирование** на основе координат.

2.  **Геокодирование** --- преобразование географических идентификаторов в координаты.

3.  **Векторизация** --- создание объектов в ручном режиме, либо путем преобразования из других моделей данных.

    ::: callout-tip
    ## Уточнение

    Векторизации-преобразованию обычно подвергаются растровые данные.
    :::

4.  **Геометрические операции** --- получение новых векторных объектов в результате операций над существующими объектами.

## Автоматическое конструирование

#### Геодезические пункты --- точечные объекты

::: columns
::: {.column width="50%"}
**Исходные данные**

![](images/image-1928425450.png)
:::

::: {.column width="50%"}
**Simple Feature**

``` {style="font-size: 8"}
Simple feature collection with 2 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 36.34953 ymin: 55.19612 xmax: 36.37369 ymax: 55.2188
Geodetic CRS:  WGS 84
N Name    geometry
  <chr>   <POINT [°]>
1 Африка  (36.34953 55.19612)
2 Сенокос (36.37369 55.2188)
```
:::
:::

## Автоматическое конструирование

#### Маршрут --- линейный объект

::: columns
::: {.column width="50%"}
**Исходные данные**

![](images/image-11396456.png)

![](images/image-1313555464.png)
:::

::: {.column width="50%"}
**Simple Feature**

```         
Geometry set for 1 feature 
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 36.34891 ymin: 55.19607 xmax: 36.38429 ymax: 55.21918
Geodetic CRS:  WGS 84
LINESTRING (36.38314 55.20975, 36.38314 55.20976, 36.3832 55.20997, 36.38321 55.21001, 36.38321 55.21002, 36.38325 55.21007...
```
:::
:::

## Автоматическое конструирование

#### Поле --- площадной объект

::: columns
::: {.column width="50%"}
**Исходные данные**

![](images/image-587177276.png)

![](images/image-635340267.png)
:::

::: {.column width="50%"}
**Simple Feature**

```         
Geometry set for 1 feature 
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 36.37781 ymin: 55.18984 xmax: 36.38543 ymax: 55.19887
Geodetic CRS:  WGS 84
POLYGON ((36.38543 55.19842, 36.38538 55.19825, 36.38533 55.19806, 36.38528 55.19785, 36.38525 55.19763, 36.38513 55.19745,...
```
:::
:::

## Автоматическое конструирование

::: columns
::: {.column width="60%"}
![](images/field_map.png)
:::

::: {.column width="40%"}
Пример использования --- построение карт по результатам полевых работ.

::: callout-caution
## Ограничения

Сырые данные ГНСС-измерений содержат погрешности. Поэтому векторные объекты, созданные на их основе, часто нуждаются в редактировании, в том числе с использованием геометрических операций.
:::
:::
:::

## Географические идентификаторы

Увязаны с местоположением, идентифицируемым географическими объектами. Взаимосвязь с объектом может быть установлена следующими основными способами:

-   **локализацией**, когда конкретная позиция находится внутри географического объекта, например в стране;

-   **локальными измерениями**, когда позиция определена относительно фиксированных точек географических объектов, например вдоль улицы на заданном расстоянии от пересечения с другой улицей. Этот аспект известен как *линейная привязка*;

-   **слабо связанным способом**, когда позиция имеет нечеткую взаимосвязь с географическими объектами, например рядом со зданием или между двумя зданиями.

## Геокодирование

Географический идентификатор [@gost:70316-2022]

:   Пространственная привязка в виде текстового обозначения или кода, определяющего местоположение

Географический справочник (газеттир)

:   Реестр экземпляров местоположений одного или более подтипов местоположений, содержащих некоторую информацию о позиции.

::: callout-note
## Адресный локатор

Географический справочник почтовых адресов и их местоположения обычно называют *адресным локатором*.
:::

## Адресное геокодирование

![](images/geocoding.png){width="100%"}

**Адресный локатор** хранит набор набор векторных объектов, для каждого из которых задано структурированное описание адреса, разбитое на компоненты: индекс, регион, нас. пункт, улица и т.д.

**Геокодер** находит в локаторе наиболее вероятное местоположение, соответствующее переданному адресу.

## Адресное геокодирование

Адресное геокодирование позволяет автоматизировать преобразование текстовых данных в пространственные.

::: columns
::: {.column width="45%"}
**Исходные данные**

![](images/addr_source.png){width="90%"}
:::

::: {.column width="55%"}
**Результаты геокодирования**

![](images/addr_res.png){width="90%"}
:::
:::

## Векторизация

**Векторизация** может осуществляться в автоматическом, автоматизированном и ручном режиме.

-   *Автоматическая векторизация* используется, например, при конвертации покрытий, хранящих категориальные данные, в набор векторных объектов.

    ![](images/vectorize.svg){width="65%"}

## Векторизация

**Векторизация** может осуществляться в автоматическом, автоматизированном и ручном режиме.

-   *Автоматизированная векторизация* используется, например, при выделении объектов на космических снимках и сканированных картах. Результирующие объекты требуют редактирования.

    ![](images/image-91314596.png)

    @yurtseven2019

## Векторизация

**Векторизация** может осуществляться в автоматическом, автоматизированном и ручном режиме.

::: columns
::: {.column width="30%"}
![](images/vec_manual_crop.gif)
:::

::: {.column width="70%"}
-   *Ручная векторизация* используется, когда автоматизированные методы не дают удовлетворительного результата, или когда надо создать новый векторный объект, для которого нет образца.

::: callout-tip
## Операции редактирования

Ручная векторизация похожа на работу в векторных графических редакторах. Объекты можно не только создавать, но также разрезать, присоединять, вырезать в них дырки и т.д.
:::
:::
:::

## Цифрование

Цифрование

:   Получение цифрового представления объектов.

::: callout-tip
## Пример

Классические пример цифрования --- получение растра топографической карты по результатам сканирования.
:::

::: callout-warning
## Соотношение с векторизацией

**Цифрование** --- более общий термин, чем *векторизация*. Для обозначения процесса создания векторных объектов необходимо употреблять термин *векторизация*.
:::

## Словарик

::: columns
::: {.column width="50%" style="color: blue; text-align: end;"}
Координатная система отсчета

Проекция

Координатная привязка

Аффинное преобразование

Проективное преобразование

Полином. преобразование

Географический справочник

Адресный локатор

Геокодирование

Векторизация

Цифрование
:::

::: {.column width="50%" style="color: red"}
Coordinate reference system

Projection

Georeferencing

Affine transformation

Projective transformation

Polynomial transformation

Gazetteer

Address locator

Geocoding

Vectorization

Digitizing
:::
:::

## Библиография
