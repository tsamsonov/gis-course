---
title: "WKT и WKB"
subtitle: "Геоинформатика I. Базы пространственных данных"
date: today
date-format: long
author: "Самсонов Тимофей Евгеньевич"
execute:
  echo: false
  freeze: true
engine: knitr
format:
  revealjs: 
    theme: [default, custom.scss]
    margin: 0.2
    width: 1280
    height: 720
    slide-number: true
    footer: "Самсонов Т. Е. Геоинформатика: курс лекций"
    header-includes: <link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/pt-sans" type="text/css"/>
bibliography: references.yaml
mainfont: PT Sans
---

## Формальная грамматика

Алфавит

:   Множество неделимых (атомарных) символов

Слово

:   Конечный упорядоченный набор (кортеж) символов из заданного алфавита

Формальный язык

:   Множество конечных слов над конечным алфавитом

Синтаксис

:   Совокупность правил, упорядочивающих структуру предложений

Формальная грамматика

:   Способ формирования из алфавита языка строк (слов, словосочетаний, предложений) в соответствии с его синтаксисом

## Формальная грамматика

Производящее правило

:   Правило замены символов, которое может применяться для генерации новой последовательности символов

Терминальные символы

:   Символы, входящие в алфавит

Нетерминальные символы

:   Заменяются группой терминальных символов в соответствии с производящими правилами

## Форма Бэкуса-Наура (БНФ)

**Форма Бэкуса-Наура (БНФ)** --- формальная грамматика с последовательным определением синаксических категорий через производящие правила вида:

`<symbol> ::= expression`

-   `<symbol>` --- нетерминальный символ (переменная)

-   `::=` --- оператор замены символа слева (`<symbol>`) на выражение справа (`expression`).

-   `expression` --- выражение, которое состоит из одной и более *альтернативных* последовательностей терминальных или нетерминальных символов (токенов)

-   `|` --- символ, используемый для разделения альтернативных последовательностей в выражении `expression`

::: callout-note
## Угловые скобки (`<>`)

В нотации Бэкуса-Наура нетерминальные символы всегда заключаются в угловые скобки (`<>`).
:::

## Форма Бэкуса-Наура (БНФ)

**БНФ** базируется на следующих обозначениях:

+---------+------------------------------------------------------------------------------------------------------------------------------+
| `{}`    | Опциональный (необязательный) токен; фигурные скобки используются для обозначения и не являются частью токена                |
+---------+------------------------------------------------------------------------------------------------------------------------------+
| `()`    | Группировка последовательности токенов в один токен; круглые скобки используются для обозначения и не являются частью токена |
+---------+------------------------------------------------------------------------------------------------------------------------------+
| `*`     | Опциональное (необязательное) использование множества экземпляров токена                                                     |
+---------+------------------------------------------------------------------------------------------------------------------------------+
| `|`     | Разделитель альтернативных токенов; не включается в результат                                                                |
+---------+------------------------------------------------------------------------------------------------------------------------------+
| `<>`    | Определяемый нетерминальный токен                                                                                            |
+---------+------------------------------------------------------------------------------------------------------------------------------+
| `::=`   | Оператор, обозначающий производящее правило: левый операнд может быть заменен на правый.                                     |
+---------+------------------------------------------------------------------------------------------------------------------------------+
|         | Последовательность символов без обозначений представляет собой терминальный токен                                            |
+---------+------------------------------------------------------------------------------------------------------------------------------+

## Определение WKT

|                                                   |
|---------------------------------------------------|
| `<empty set> ::= EMPTY`                           |
| `<left paren> ::= (`                              |
| `<right paren> ::= )`                             |
| `<comma> ::= ,`                                   |
| `<period> ::= .`                                  |
| `<decimal point> ::= .`                           |
| `<digit> ::= 0|1|2|3|4|5|6|7|8|9`                 |
| `<plus sign> ::= +`                               |
| `<minus sign> ::= -`                              |
| `<sign> ::= <plus sign> | <minus sign>`           |
| `<unsigned integer> ::= (<digit>)*`               |
| `<signed integer> ::= {<sign>}<unsigned integer>` |

## Разложение целого со знаком

![](images/signed_integer.svg){width="50%"}

## Определение WKT

+---------------------------------------------------------------------------------------------------------------------------+
| `<exact numeric literal> ::= <unsigned integer> {<decimal po int>{<unsigned integer>}}|<decimal point><unsigned integer>` |
+---------------------------------------------------------------------------------------------------------------------------+
| `<mantissa> ::= <exact numeric literal>`                                                                                  |
+---------------------------------------------------------------------------------------------------------------------------+
| `<exponent> ::= <signed integer>`                                                                                         |
+---------------------------------------------------------------------------------------------------------------------------+
| `<approximate numeric literal> ::= <mantissa>E<exponent>`                                                                 |
+---------------------------------------------------------------------------------------------------------------------------+
| `<unsigned numeric literal> ::= <exact numeric literal> | <approximate numeric literal>`                                  |
+---------------------------------------------------------------------------------------------------------------------------+
| `<signed numeric literal> ::= {<sign>}<unsigned numeric literal>`                                                         |
+---------------------------------------------------------------------------------------------------------------------------+
| `<x> ::= <signed numeric literal>`                                                                                        |
+---------------------------------------------------------------------------------------------------------------------------+
| `<y> ::= <signed numeric literal>`                                                                                        |
+---------------------------------------------------------------------------------------------------------------------------+
| `<z> ::= <signed numeric literal>`                                                                                        |
+---------------------------------------------------------------------------------------------------------------------------+
| `<m> ::= <signed numeric literal>`                                                                                        |
+---------------------------------------------------------------------------------------------------------------------------+

## Разложение действительного числа

![](images/signed_literal.svg){width="100%"}

## Определение $2D$-геометрий

+---------------------------------------------------------------------------------------------+
| `<point> ::= <x> <y>`                                                                       |
+---------------------------------------------------------------------------------------------+
| `<point text> ::= <empty set> | <left paren>`                                               |
|                                                                                             |
| `<point> <right paren>`                                                                     |
+---------------------------------------------------------------------------------------------+
| `<point tagged text> ::= point <point text>`                                                |
+---------------------------------------------------------------------------------------------+
| `<linestring text> ::= <empty set> | <left paren> <point> {<comma> <point>}* <right paren>` |
+---------------------------------------------------------------------------------------------+
| `<linestring tagged text> ::= linestring <linestring text>`                                 |
+---------------------------------------------------------------------------------------------+
| `<polygon text> ::= <empty set> | <left paren>`                                             |
|                                                                                             |
| `<linestring text>{<comma> <linestring text>}* <right paren>`                               |
+---------------------------------------------------------------------------------------------+
| `<polygon tagged text> ::= polygon <polygon text>`                                          |
+---------------------------------------------------------------------------------------------+
| `<triangle tagged text> ::= triangle <polygon text>`                                        |
+---------------------------------------------------------------------------------------------+

## Разложение $2D$-точки

![](images/point_tagged.svg){width="100%"}

## Разложение $2D$-линии и полигона

![](images/line_polygon_tagged.svg){width="100%"}

## Определение $2D$-геометрий

+------------------------------------------------------------------------------------------------------------------+
| `<polyhedralsurface text> ::= <empty set> | <left paren> <polygon text> {<comma> <polygon text>}* <right paren>` |
+------------------------------------------------------------------------------------------------------------------+
| `<polyhedralsurface tagged text> ::= polyhedralsurface <polyhedralsurface text>`                                 |
+------------------------------------------------------------------------------------------------------------------+
| `<tin tagged text> ::= tin <polyhedralsurface text>`                                                             |
+------------------------------------------------------------------------------------------------------------------+

![](images/tin_tagged.svg){width="100%"}

## Определение $2D$-коллекций

+---------------------------------------------------------------------------------------------------------------------+
| `<multipoint text> ::= <empty set> | <left paren>`                                                                  |
|                                                                                                                     |
| `<point text> {<comma> <point text>}* <right paren>`                                                                |
+---------------------------------------------------------------------------------------------------------------------+
| `<multipoint tagged text> ::= multipoint <multipoint text>`                                                         |
+---------------------------------------------------------------------------------------------------------------------+
| `<multilinestring text> ::= <empty set> | <left paren> <linestring text>{<comma> <linestring text>}* <right paren>` |
+---------------------------------------------------------------------------------------------------------------------+
| `<multilinestring tagged text> ::= multilinestring <multilinestring text>`                                          |
+---------------------------------------------------------------------------------------------------------------------+
| `<multipolygon text> ::= <empty set> | <left paren>`                                                                |
|                                                                                                                     |
| `<polygon text> {<comma> <polygon text>}* <right paren>`                                                            |
+---------------------------------------------------------------------------------------------------------------------+
| `<multipolygon tagged text> ::=`                                                                                    |
|                                                                                                                     |
| `multipolygon <multipolygon text>`                                                                                  |
+---------------------------------------------------------------------------------------------------------------------+

## Разложение $2D$-мульти\[точки\|линии\]

![](images/multipoint_tagged.svg){width="100%"}

## Разложение $2D$-мультиполигона

![](images/multipolygon_tagged.svg){width="100%"}

## Определение $2D$-`GEOMETRYCOLLECTION`

+-----------------------------------------------------------------------------------------------------------------------------------+
| `<geometry tagged text> ::=`                                                                                                      |
|                                                                                                                                   |
| `<point tagged text> | <linestring tagged text>`                                                                                  |
|                                                                                                                                   |
| `| <polygon tagged text> | <triangle tagged text>`                                                                                |
|                                                                                                                                   |
| `| <polyhedralsurface tagged text> | <tin tagged text>`                                                                           |
|                                                                                                                                   |
| `| <multipoint tagged text> | <multilinestring tagged text>`                                                                      |
|                                                                                                                                   |
| `| <multipolygon tagged text>`                                                                                                    |
|                                                                                                                                   |
| `| <geometrycollection tagged text>`                                                                                              |
+-----------------------------------------------------------------------------------------------------------------------------------+
| `<geometrycollection text> ::= <empty set> | <left paren> <geometry tagged text> {<comma> <geometry tagged text>}* <right paren>` |
+-----------------------------------------------------------------------------------------------------------------------------------+
| `<geometrycollection tagged text> ::= geometrycollection <geometrycollection text>`                                               |
+-----------------------------------------------------------------------------------------------------------------------------------+

## Разложение $2D$-`GEOMETRYCOLLECTION`

![](images/geometry_tagged.svg){width="100%"}

## Определение $3D/4D$-геометрий и коллекций

Идентично $2D$ со следующими модификациями:

-   Количество координат равно числу измерений ($3$ или $4$)

-   После названия *tagged*-геометрии добавляется расширение `z`, `m` или `zm`:\
    `point z`, `linestring m`, `polygon zm`.

![](images/linestringzm_tagged.svg){width="100%"}

## Дополнительные измерения

1.  Стандартные геометрические операции и топологические предикаты *игнорируют* дополнительные измерения $ZM$.

2.  Не существует ограничений на координату $M$ --- она, в частности, не обязана непрерывно возрастать вдоль объекта `LINESTRING`.

3.  Интерфейс объектов с $M$-геометрией содержит дополнительные методы `LocateAlong()` и `LocateBetween()`.

+-------------------------+-------------------------------------------------------------------------------------------+
| Метод                   | Назначение                                                                                |
+=========================+===========================================================================================+
| `LocateAlong(m)`        | Возвращает производную геометрическую коллекцию, которая соответствует `m`                |
+-------------------------+-------------------------------------------------------------------------------------------+
| `LocateBetween(m1, m2)` | Возвращает производную геометрическую коллекцию, которая соответствует отрезку `[m1, m2]` |
+-------------------------+-------------------------------------------------------------------------------------------+

## Дополнительные измерения

Запрос измерения мультиточечного объекта:

**`p:`** `MULTIPOINT M(0 0 4, 2 1 1, 3 1 2, 4 2 4, 5 3 5, 7 2 7)`

**`p.LocateAlong(4):`** `MULTIPOINT M(0 0 4, 3 1 4)`

**`p.LocateBetween(2,4):`** `MULTIPOINT M(0 0 4, 2 1 2, 3 1 4)`

**`p.LocateAlong(3):`** `POINT M()` --- *пустой* объект

```{python}
#| fig-width: 3
#| fig-height: 1.5
#| out-width: 600px
#| out-height: 450px

import shapely
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt

mpts = shapely.MultiPoint(((0, 0), (2, 1), (3, 1), (4, 2), (5, 3), (7, 2)))
gmpts = gpd.GeoSeries(mpts)
df = pd.DataFrame({})
gdf = gpd.GeoDataFrame(df, geometry=gmpts)
gdf.plot(markersize = 50, color='orangered')
plt.show()
```

## Дополнительные измерения

Запрос измерения линейного объекта :

**`l:`** `MULTILINESTRING M((0 0 4, 2 1 1, 3 1 2), (4 2 4, 5 3 6))`

**`l.LocateAlong(3):`** `MULTIPOINT M(1.3 0.7 3)`

**`l.LocateBetween(2,5):`** `GEOMETRYCOLLECTION M(LINESTRING M(0 0 4,1.33 0.67 2),POINT M(3 1 2),LINESTRING M(4 2 4,4.5 2.5 5))`

**`l.LocateAlong(0.5):`** `POINT M()` --- *пустой* объект

```{python}
#| fig-width: 3
#| fig-height: 1.5
#| out-width: 600px
#| out-height: 300px
mline = shapely.MultiLineString((((0, 0), (2, 1), (3, 1)), ((4, 2), (5, 3), (7, 2))))
gmline = gpd.GeoSeries(mline)
df = pd.DataFrame({})
gdf = gpd.GeoDataFrame(df, geometry=gmline)
gdf.plot(color='orangered')
plt.show()
```

## Библиография
